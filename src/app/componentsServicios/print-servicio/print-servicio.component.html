<div>
  <app-title-bar [titulo]="title"></app-title-bar>

  <section id="seccionInfoServicio">
    <div class="cardContainer">
      <div class="container">

        <!-- Información básica del servicio -->

        <mat-grid-list cols="8" rowHeight="6rem">

          <mat-grid-tile [colspan]="6" [rowspan]="1" [style.background]="''">

            <mat-form-field appearance="fill">
              <mat-label>Responsable general</mat-label>
              <input matInput [value]="servicioRecibido.fullname_responsable" [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="2" [rowspan]="1" [style.background]="''">

            <button mat-flat-button color="accent" style="width: 100%;"
              [matMenuTriggerFor]="enableMenuEdit() ? menu : null">
              SERVICIO N° {{ servicioRecibido.idServicio }}
              <mat-icon *ngIf="enableMenuEdit()" class="mat-icon">tune</mat-icon>
            </button>
            <mat-menu id="matMenu" #menu="matMenu" xPosition="before">
              <button mat-menu-item (click)="editarServicio()" class="editMenu">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item (click)="checkDelete()" class="deleteMenu">
                <mat-icon>delete</mat-icon>
                <span>Eliminar</span>
              </button>
            </mat-menu>

          </mat-grid-tile>

        </mat-grid-list>

        <!-- Información del cliente / empresa -->

        <mat-grid-list cols="8" rowHeight="6rem">

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field appearance="fill">
              <mat-label>Cliente</mat-label>
              <input matInput [value]="servicioRecibido.cliente" [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field appearance="fill">
              <mat-label>Rubro</mat-label>
              <input matInput [value]="servicioRecibido.rubro" [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="2" [rowspan]="1" [style.background]="''">

            <button style="width: 100%;" mat-flat-button color="primary" (click)="openContactPopUp()">
              CONTACTO CLIENTE
            </button>

          </mat-grid-tile>

        </mat-grid-list>

        <!-- Información detallada del servicio -->

        <mat-grid-list cols="12" rowHeight="6rem">

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field appearance="fill">
              <mat-label>Tipo de servicio</mat-label>
              <input matInput [value]="servicioRecibido.tipo" [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field>
              <mat-label [style.color]="isEditable ? '#dc3545' : '#673ab7'">Estado</mat-label>
              <input matInput *ngIf="!isEditable" [value]="servicioRecibido.estado" [readonly]="!isEditable">
              <mat-icon matIconPrefix class="advertIcon" *ngIf="hayNotificados()" (click)="alertaNotificado()">adjust</mat-icon>
              <mat-select *ngIf="isEditable" [(ngModel)]="servicioRecibido.estado" (ngModelChange)="onEstadoChange()" [disabled]="hayNotificados()">
                <mat-option class="option" *ngFor="let estado of estadosList" [value]="estado.tipoEstado" #optionRef
                [disabled]="blockOrder ? blockLowOrder(estado) : null" (click)="warnEnable(optionRef)">
                  {{ estado.tipoEstado }}
                </mat-option>
              </mat-select>
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field>
              <mat-label [style.color]="isEditable ? '#dc3545' : ''">Fecha de recordatorio</mat-label>
              <input matInput [matDatepicker]="picker" [min]="minDate" [max]="maxDate"
              [(ngModel)]="servicioRecibido.fecha_notificacion" [value]="servicioRecibido.fecha_notificacion" [readonly]="true">
              <mat-hint>DD/MM//YYYY</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker [disabled]="!isEditable || checkEditable()"></mat-datepicker>
            </mat-form-field>

          </mat-grid-tile>

          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-card style="width: 100%">
              <mat-card-content style="max-height: 3.74rem; padding-top: 0.74rem;">
                <div>
                  <mat-label style="font-size: 1rem;">
                    {{ getAvance() === 0 ? 'Sin ítems completos' : getAvance() === 100 ? 'ítems 100% completos' :
                    'Avance' }}
                  </mat-label>
                  <div class="progress" role="progressbar" [attr.aria-valuenow]="getAvance()" aria-valuemin="0"
                    aria-valuemax="100">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" [style.width.%]="getAvance()">
                      <span>{{ getAvance() === 100 ? 'Completo' : getAvance() + '%' }}</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

          </mat-grid-tile>



        </mat-grid-list>

        <mat-grid-list cols="12" rowHeight="6rem">

          <!-- Hay renovaciones -->
          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''" *ngIf="recurrencia === 0">

            <mat-form-field appearance="fill">
              <mat-label>Renovaciones y referencia</mat-label>
              <input matInput [value]="'Cantidad: ' +recurrencia + ' Ref-ID: ' + servicioRecibido.referencia"
                [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <!-- No hay renovaciones -->
          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''" *ngIf="recurrencia > 0">

            <mat-form-field appearance="fill">
              <mat-label>Renovaciones</mat-label>
              <input matInput value="Sin renovaciones" [readonly]="true">
            </mat-form-field>

          </mat-grid-tile>

          <!-- Presupuesto -->
          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <mat-form-field floatLabel="always">
              <mat-label [style.color]="isEditable ? '#dc3545' : ''">Presupuesto</mat-label>
              <input matInput type="number" style="text-align: center;" [(ngModel)]="servicioRecibido.total_presupuestado" 
                placeholder="0" [readonly]="!isEditable" [disabled]="checkEditable()" (blur)="validarPresupuesto()" (input)="limitarLongitud($event)" #presupuestoInput>
              <span matTextPrefix>$&nbsp;</span>
            </mat-form-field>

          </mat-grid-tile>

          <!-- Disponible para editar el expediente -->
          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

          </mat-grid-tile>

          <!-- Pop up del checklist -->
          <mat-grid-tile [colspan]="3" [rowspan]="1" [style.background]="''">

            <button style="width: 100%;" mat-flat-button color="primary" 
            (click)="openChecklistPopUp()" *ngIf="!isEditable" [disabled]="checkEditable()">
              <mat-icon class="mat-icon">checklist</mat-icon>
              ABRIR CHECKLIST
            </button>

            <button style="width: 100%;" (click)="loadChanges()" mat-flat-button color="accent" *ngIf="isEditable" [disabled]="!isEditable">
              <mat-icon class="mat-icon">save</mat-icon>
              GUARDAR CAMBIOS
            </button>

          </mat-grid-tile>

        </mat-grid-list>

        <mat-grid-list cols="12" rowHeight="6rem">
        
          <mat-grid-tile [colspan]="12" [rowspan]="1" [style.background]="''">
        
            <mat-form-field appearance="fill">
              <mat-label [style.color]="isEditable ? '#dc3545' : ''">Comentario</mat-label>
              <textarea style="font-style: oblique; padding: 0;" class="card-text" [(ngModel)]="servicioRecibido.comentario"
                matInput [readonly]="!isEditable" [disabled]="checkEditable()" maxlength="500">
                {{servicioRecibido.comentario}}
              </textarea>
              <mat-error *ngIf="servicioRecibido.comentario && servicioRecibido.comentario.length >= 500">
                El comentario no puede tener más de 500 caracteres.
              </mat-error>
            </mat-form-field>
        
          </mat-grid-tile>
        
        </mat-grid-list>

      </div>
    </div>
  </section>
</div>